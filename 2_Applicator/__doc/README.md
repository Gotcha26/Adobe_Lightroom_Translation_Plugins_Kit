# Applicator - Technical Documentation

**Version 7.0 | January 2026**

## Overview

Applicator is the second tool in the localization chain. Its role is to automatically apply replacements in Lua code by transforming hardcoded strings into calls to the Lightroom SDK's `LOC` function.

## Project Architecture

```
2_Applicator/
├── Applicator_main.py        ← Entry point, main logic
├── Applicator_menu.py        ← Interactive interface
└── __doc/
    └── README.md             ← This file
```

The architecture is intentionally simple: a single main file contains all the logic. This facilitates understanding and occasional modifications.

## Detailed Operation

### Phase 1: Loading Extraction Data

```
Extractor folder (auto-detected)
    │
    ├── replacements.json
    │   │
    │   └── Structure:
    │       {
    │         "files": {
    │           "MyFile.lua": {
    │             "replacements": [
    │               {
    │                 "line_num": 42,
    │                 "original_line": "title = \"Submit\",",
    │                 "members": [...]
    │               }
    │             ]
    │           }
    │         }
    │       }
    │
    └── spacing_metadata.json (optional)
```

Applicator reads the `replacements.json` file generated by Extractor. This file contains all the precise instructions for each line to modify.

### Phase 2: Applying Replacements

```
For each .lua file
    │
    ├── Read file line by line
    │
    ├── For each line referenced in replacements.json
    │   │
    │   ├── Search for each string (double AND single quotes)
    │   │
    │   ├── Verify string is not already in a LOC
    │   │
    │   ├── Build LOC call with metadata
    │   │   │
    │   │   ├── Leading spaces: '" " .. '
    │   │   ├── LOC call: 'LOC "$$$/Key=Default"'
    │   │   ├── Suffix: ' .. ":"'
    │   │   └── Trailing spaces: ' .. " "'
    │   │
    │   └── Replace in line
    │
    ├── Create backup (.bak) BEFORE modification
    │
    └── Write modified file
```

### Phase 3: Report Generation

```
Application report
    │
    ├── Global statistics
    │   ├── Files processed
    │   ├── Files modified
    │   ├── Lines modified
    │   └── Strings replaced
    │
    ├── Modification details
    │   ├── File: MyDialog.lua
    │   ├── Line 42
    │   ├── BEFORE: title = "Submit",
    │   ├── AFTER: title = LOC "$$$/App/Submit=Submit",
    │   └── Strings: "Submit" → $$$/App/Submit
    │
    └── Post-processing recommendations
        ├── Verify with git diff
        ├── Restart Lightroom (reload is not enough)
        └── Test texts in the interface
```

## Lightroom SDK Format

The Lightroom SDK requires a strict format for localization:

```lua
LOC "$$$/Key=Default Value"
```

### Why is the default value mandatory?

Without a default value, Lightroom displays the raw key (`$$$/App/Submit`) instead of the text. This is unattractive and confusing for the user.

### Transformation Examples

**Simple:**
```lua
-- BEFORE
title = "Submit"

-- AFTER
title = LOC "$$$/Piwigo/Submit=Submit"
```

**With spaces:**
```lua
-- BEFORE
label = "  Username:  "

-- AFTER
label = "  " .. LOC "$$$/Piwigo/Username=Username" .. ":  "
```

**Concatenation:**
```lua
-- BEFORE
message = "Uploading " .. count .. " photos"

-- AFTER
message = LOC "$$$/Piwigo/Uploading=Uploading " .. count .. LOC "$$$/Piwigo/Photos= photos"
```

**Single quotes:**
```lua
-- BEFORE
text = 'Hello World'

-- AFTER
text = LOC "$$$/Piwigo/HelloWorld=Hello World"
```

## Configuration Options

### Interactive Mode

Run `Applicator_main.py` to access the menu:

```
==================================================
        APPLICATOR - Configuration
==================================================

Configured plugin: ./myPlugin.lrplugin

Last extraction detected:
  __i18n_tmp__/Extractor/20260129_143022/

Options:
  [1] Use this extraction
  [2] Select another extraction
  [3] Dry-run mode (simulation)
  [4] Backup options
  [0] Cancel
```

### CLI Mode

```bash
python Applicator_main.py --plugin-path ./plugin.lrplugin [OPTIONS]
```

**Available options:**

| Option | Description | Default | Example |
|--------|-------------|---------|---------|
| `--plugin-path` | Plugin path (REQUIRED) | - | `./myPlugin.lrplugin` |
| `--extraction-dir` | Specific Extractor folder | Auto-detection | `./plugin/__i18n_tmp__/Extractor/20260129_143022/` |
| `--dry-run` | Simulation mode (no modification) | false | `--dry-run` |
| `--no-backup` | Don't create .bak backups | false (backup active) | `--no-backup` |

### Usage Examples

**Standard application with auto-detection:**
```bash
python Applicator_main.py --plugin-path ./piwigoPublish.lrplugin
```

**Dry-run mode (simulation):**
```bash
python Applicator_main.py --plugin-path ./plugin.lrplugin --dry-run
```

**Application without backup (not recommended):**
```bash
python Applicator_main.py --plugin-path ./plugin.lrplugin --no-backup
```

**Application with specific extraction:**
```bash
python Applicator_main.py \
  --plugin-path ./plugin.lrplugin \
  --extraction-dir ./plugin/__i18n_tmp__/Extractor/20260128_120000/
```

## Backup Structure

Backups are essential for restoring files in case of errors.

### Organization

```
myPlugin.lrplugin/
├── MyDialog.lua                     ← Modified file
├── Settings.lua                     ← Modified file
└── __i18n_tmp__/
    └── Applicator/
        └── 20260129_143530/         ← Application timestamp
            ├── application_report.txt
            └── backups/
                ├── MyDialog.lua.bak
                └── Settings.lua.bak
```

Each execution creates a new timestamped folder with its own backups.

### Manual Restoration

If you need to restore manually:

```bash
# Restore a file
cp myPlugin.lrplugin/__i18n_tmp__/Applicator/20260129_143530/backups/MyDialog.lua.bak \
   myPlugin.lrplugin/MyDialog.lua

# Restore all files
cp myPlugin.lrplugin/__i18n_tmp__/Applicator/20260129_143530/backups/*.bak \
   myPlugin.lrplugin/
```

Or use the `Restore_backup.py` tool from the kit.

## Handling Complex Cases

### Lines Already Partially Localized

Applicator detects if a line already contains `LOC` calls and only applies necessary replacements.

```lua
-- Mixed line (before)
title = "Prefix " .. LOC "$$$/App/Existing=Existing" .. " Suffix"

-- Applicator detects existing LOC and only replaces "Prefix " and " Suffix"
title = LOC "$$$/App/Prefix=Prefix " .. LOC "$$$/App/Existing=Existing" .. LOC "$$$/App/Suffix= Suffix"
```

### Double vs Single Quotes

Lua accepts both types of quotes. Applicator detects both:

```lua
-- Double quotes
title = "Submit"  -- ✓ Detected

-- Single quotes
title = 'Submit'  -- ✓ Detected

-- Escaped quotes
text = "He said: \"Hello\""  -- ✓ Handled correctly
```

### Multiple Positions of Same String

If a string appears multiple times on the same line:

```lua
-- Before
text = "OK" .. separator .. "OK"

-- After (each occurrence replaced)
text = LOC "$$$/App/OK=OK" .. separator .. LOC "$$$/App/OK_2=OK"
```

Applicator avoids duplicates by tracking already-used positions.

## Extraction Auto-detection

Applicator automatically searches for the latest extraction in `__i18n_tmp__/Extractor/`.

### Detection Algorithm

```
1. Search for __i18n_tmp__/Extractor/ folder in plugin
2. List all timestamped subfolders (YYYYMMDD_HHMMSS)
3. Sort by descending timestamp
4. Take the most recent one containing replacements.json
```

If no folder is found, Applicator displays an error and asks to run Extractor first.

### Force a Specific Extraction

If you want to use an older extraction:

```bash
python Applicator_main.py \
  --plugin-path ./plugin.lrplugin \
  --extraction-dir ./plugin/__i18n_tmp__/Extractor/20260127_090000/
```

## Application Report

The `application_report.txt` file contains all execution details.

### Report Structure

```
================================================================================
LOCALIZATION REPORT - PiwigoPublish Plugin
================================================================================

GLOBAL STATISTICS
--------------------------------------------------------------------------------
Files processed        : 12
Files modified         : 8
Lines modified         : 156
Strings replaced       : 142
Strings ignored        : 14
Errors                 : 0

================================================================================
MODIFICATIONS PERFORMED
================================================================================

--------------------------------------------------------------------------------
File: MyDialog.lua
--------------------------------------------------------------------------------

  Line 42:
  BEFORE: title = "Submit",
  AFTER: title = LOC "$$$/Piwigo/Submit=Submit",
    - "Submit" -> $$$/Piwigo/Submit

  Line 58:
  BEFORE: label = "Username:"
  AFTER: label = LOC "$$$/Piwigo/Username=Username" .. ":"
    - "Username" -> $$$/Piwigo/Username

...

================================================================================
IGNORED STRINGS
================================================================================

  MyDialog.lua:23
    Reason: String already localized
    Content: title = LOC "$$$/Piwigo/ExistingKey=Value",

  Settings.lua:67
    Reason: String not found (modified since extraction?)
    Content: text = "Old Value"

================================================================================
POST-PROCESSING RECOMMENDATIONS
================================================================================

1. Verify modifications with Git diff
2. RESTART Lightroom Classic (reload is not enough)
3. Verify that TranslatedStrings_en.txt exists at the root
4. Test texts in the interface
```

### Interpreting Statistics

- **Files modified**: Number of files where at least one replacement was performed
- **Lines modified**: Number of transformed lines
- **Strings replaced**: Total number of strings converted to LOC
- **Strings ignored**: Strings not replaced (already LOC, not found, etc.)

## Managing Translation Files

After application, Applicator offers to manage `TranslatedStrings_xx.txt` files.

### Scenario 1: No Translation File

```
No TranslatedStrings_xx.txt file found at plugin root.
This file is necessary for Lightroom translations.

A template file was found in the extraction:
  __i18n_tmp__/Extractor/20260129_143022/TranslatedStrings_en.txt

Do you want to copy it to the plugin root?
  -> ./myPlugin.lrplugin/TranslatedStrings_en.txt

Copy file? [Y/n]:
```

If you accept, the file is copied automatically.

### Scenario 2: Existing Files

```
Translation file(s) found:
  - TranslatedStrings_en.txt
  - TranslatedStrings_fr.txt

Do you want to open the translation manager (TranslationManager)?
This allows synchronizing translations with new keys.

Open TranslationManager? [y/N]:
```

If you accept, TranslationManager is launched automatically.

## Advanced Use Cases

### Application in Dry-run Mode for Validation

Before actually applying modifications, test in dry-run:

```bash
# 1. Dry-run to see what will be modified
python Applicator_main.py --plugin-path ./plugin.lrplugin --dry-run

# 2. Consult the report
cat ./plugin.lrplugin/__i18n_tmp__/Applicator/<timestamp>/application_report.txt

# 3. If OK, actually apply
python Applicator_main.py --plugin-path ./plugin.lrplugin
```

### Application After Manual Modification of replacements.json

If you edited `replacements.json` to customize keys or values:

```bash
# Apply with your modified replacements.json
python Applicator_main.py \
  --plugin-path ./plugin.lrplugin \
  --extraction-dir ./path/to/modified/extraction/
```

### Selective Application (Certain Files Only)

Edit `replacements.json` to keep only desired files:

```json
{
  "files": {
    "MyDialog.lua": { ... },
    // Remove other files
  }
}
```

Then run Applicator normally.

### Reapplication After Code Modification

If you modified code after extraction but before application:

1. Rerun Extractor to generate a new `replacements.json`
2. Then run Applicator with the new extraction

## Troubleshooting

### Error: "No extraction found"

**Cause:** No `__i18n_tmp__/Extractor/` folder in plugin.

**Solution:**
```bash
# Run Extractor first
python 1_Extractor/Extractor_main.py --plugin-path ./plugin.lrplugin
```

### Error: "replacements.json file not found"

**Cause:** The extraction folder is incomplete or corrupted.

**Solution:**
```bash
# Rerun a complete extraction
python 1_Extractor/Extractor_main.py --plugin-path ./plugin.lrplugin
```

### Strings Not Replaced

If expected strings are not replaced:

**Possible causes:**
1. Code changed since extraction (different line)
2. String is already in a LOC
3. Quotes are different (escaped, etc.)

**Solutions:**
1. Rerun Extractor to update `replacements.json`
2. Check report in "IGNORED STRINGS" section
3. Manually verify the affected file

### Lightroom Doesn't Display Translations

**Checks:**

1. Is the `TranslatedStrings_xx.txt` file at plugin root?
```bash
ls ./myPlugin.lrplugin/TranslatedStrings_*.txt
```

2. Does the code contain LOC calls?
```bash
grep "LOC " ./myPlugin.lrplugin/*.lua
```

3. Has Lightroom been restarted (not just "Reload Plugin")?

4. Does system language match the file?
   - French system → `TranslatedStrings_fr.txt`
   - English system → `TranslatedStrings_en.txt`

### Corrupted or Missing Backups

If backups are corrupted:

1. Verify integrity:
```bash
diff ./plugin.lrplugin/MyFile.lua \
     ./plugin.lrplugin/__i18n_tmp__/Applicator/<timestamp>/backups/MyFile.lua.bak
```

2. If necessary, restore from Git:
```bash
git checkout HEAD -- ./plugin.lrplugin/MyFile.lua
```

## Technical FAQ

### Can I apply the same replacements.json twice?

No, the second application would fail because strings are already in LOC. Applicator would detect them as "already localized".

### Are backups automatically deleted?

No, they remain in `__i18n_tmp__/Applicator/` until you manually delete them or use the `Delete_temp_dir.py` tool.

### Can I undo an application without backups?

If you don't have backups, use Git to restore:
```bash
git checkout HEAD -- myPlugin.lrplugin/*.lua
```

This is why it's recommended to version your code with Git.

### Does Applicator modify Info.lua?

Yes, if `Info.lua` contains strings to localize and they are in `replacements.json`. Generally, `Info.lua` contains little localizable text (plugin name, version, etc.).

### Can I customize the generated LOC format?

The `LOC "$$$/Key=Default"` format is required by the Lightroom SDK. If you modify the format, Lightroom will not recognize the keys.

### How to handle dynamic text translations?

For dynamic text (e.g., "Uploading 5 photos"), separate static from dynamic text:

```lua
-- Before
message = "Uploading " .. count .. " photos"

-- After (by Applicator)
message = LOC "$$$/App/Uploading=Uploading " .. count .. LOC "$$$/App/Photos= photos"
```

Translations can then adapt the order:
```
# English
"$$$/App/Uploading=Uploading "
"$$$/App/Photos= photos"

# French
"$$$/App/Uploading=Envoi de "
"$$$/App/Photos= photos"
→ "Envoi de 5 photos"
```

## Performance

### Typical Execution Times

- Small plugin (5-10 files, 50 replacements): < 1 second
- Medium plugin (20-30 files, 200 replacements): 2-3 seconds
- Large plugin (50+ files, 500+ replacements): 5-10 seconds

### Backup Impact

Backup creation adds ~10-20% execution time. This is negligible and essential for safety.

### Possible Optimizations

Applicator is already optimized, but you can:

1. Use `--no-backup` if you have Git (minimal time gain)
2. Exclude files in Extractor to reduce `replacements.json`
3. Apply during non-active development hours

## Integration in Automated Workflow

### Example Complete Bash Script

```bash
#!/bin/bash
# apply_localization.sh

PLUGIN_PATH="./myPlugin.lrplugin"

echo "=== Step 1: Extraction ==="
python 1_Extractor/Extractor_main.py --plugin-path "$PLUGIN_PATH"

if [ $? -ne 0 ]; then
  echo "Error during extraction"
  exit 1
fi

echo ""
echo "=== Step 2: Application (dry-run) ==="
python 2_Applicator/Applicator_main.py --plugin-path "$PLUGIN_PATH" --dry-run

read -p "Actually apply modifications? [y/N] " -n 1 -r
echo
if [[ $REPLY =~ ^[OoYy]$ ]]; then
  echo ""
  echo "=== Step 3: Actual application ==="
  python 2_Applicator/Applicator_main.py --plugin-path "$PLUGIN_PATH"

  if [ $? -eq 0 ]; then
    echo "✓ Localization applied successfully"
    echo "  Don't forget to restart Lightroom to test"
  else
    echo "✗ Error during application"
    exit 1
  fi
else
  echo "Application cancelled"
fi
```

### Example with Python and Git Validation

```python
#!/usr/bin/env python3
import subprocess
import sys

def run_command(cmd, description):
    """Execute a command and display the result."""
    print(f"\n=== {description} ===")
    result = subprocess.run(cmd, shell=True)
    return result.returncode == 0

def main():
    plugin_path = "./myPlugin.lrplugin"

    # Extraction
    if not run_command(
        f"python 1_Extractor/Extractor_main.py --plugin-path {plugin_path}",
        "Extraction"
    ):
        print("Error during extraction")
        return 1

    # Application dry-run
    if not run_command(
        f"python 2_Applicator/Applicator_main.py --plugin-path {plugin_path} --dry-run",
        "Application (dry-run)"
    ):
        print("Error during dry-run")
        return 1

    # Confirmation
    response = input("\nApply modifications? [y/N] ")
    if response.lower() not in ['o', 'oui', 'y', 'yes']:
        print("Application cancelled")
        return 0

    # Actual application
    if not run_command(
        f"python 2_Applicator/Applicator_main.py --plugin-path {plugin_path}",
        "Actual application"
    ):
        print("Error during application")
        return 1

    # Git verification
    print("\n=== Verification of modifications (Git) ===")
    subprocess.run("git diff", shell=True)

    print("\n✓ Localization applied successfully")
    print("  Restart Lightroom to test modifications")

    return 0

if __name__ == "__main__":
    sys.exit(main())
```

## Post-application Checklist

After running Applicator, follow this checklist:

- [ ] Consult application report (`application_report.txt`)
- [ ] Verify modifications with `git diff`
- [ ] Ensure `TranslatedStrings_en.txt` is at plugin root
- [ ] Copy and translate files for other languages (`TranslatedStrings_fr.txt`, etc.)
- [ ] **Restart** Lightroom Classic (not just "Reload Plugin")
- [ ] Test all plugin user interfaces
- [ ] Verify texts display correctly
- [ ] Validate that spaces and formatting are preserved
- [ ] Commit modifications in Git with a clear message

## Additional Resources

- **Lightroom SDK**: [Adobe Developer Console](https://developer.adobe.com/console)
- **LOC Format**: `LOC "$$$/Key=Default"` (official documentation)
- **Python Regular Expressions**: [re Documentation](https://docs.python.org/3/library/re.html)
- **Python JSON**: [json Documentation](https://docs.python.org/3/library/json.html)

## Contributions

To improve Applicator, you can:
- Add new handling cases (complex escaped quotes, etc.)
- Optimize detection of already localized strings
- Improve application report
- Add additional validations

Feel free to propose your modifications!

---

**Developed by Julien MOREAU with help from Claude (Anthropic)**

For any questions or issues, consult the main README or open an issue on the GitHub repository.
